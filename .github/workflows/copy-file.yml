name: Copy File from Extended Repo

on:
  push:
    branches:
      - main

jobs:
  copy-file:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Git
      run: |
        git config --global user.email "61996354+maximuslotro@users.noreply.github.com"
        git config --global user.name "maximuslotro"

    - name: Clone private repository
      env:
        PAT: ${{ secrets.EXTENDED_REPO_CODE }}
      run: |
        git clone https://maximuslotro:${PAT}@github.com/maximuslotro/LotrRenewedExtended.git private-repo
        git checkout main  # Ensure we are on the main branch

    - name: Find latest commit for en_us.json
      id: get-commit
      run: |
        cd private-repo
        COMMIT_HASH=$(git log -n 1 --pretty=format:%H -- src/generated/resources/assets/lotrextended/lang/en_us.json)
        echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT

    - name: Check if commit hash has changed
      id: check-commit
      run: |
        PREVIOUS_COMMIT_HASH=${{ vars.LASTENUSCOMMENT }}
        CURRENT_COMMIT_HASH=${{ steps.get-commit.outputs.COMMIT_HASH }}
          if [ "$PREVIOUS_COMMIT_HASH" != "$CURRENT_COMMIT_HASH" ]; then
            echo "Commit hash has changed. Proceeding with file push."
            gh variable set LASTENUSCOMMENT --body "testvariavle"
          else
            echo "Commit hash has not changed. Skipping."
            exit 0  # Exit successfully without further actions
          fi
      env:
        GITHUB_TOKEN: ${{ secrets.EXTENDED_LANG_REPO_CODE }}

    - name: Copy file
      run: |
        mkdir -p private-repo/upstream/
        cp private-repo/src/generated/resources/assets/lotrextended/lang/en_us.json private-repo/upstream/en_us.json

    - name: Checkout source repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        clean: false

    - name: Check for existing PR
      id: pr-check
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        PR_URL=$(gh pr list --head maximuslotro:update-from-private-lang --json url --jq '.[0].url' || echo "none")
        echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT

    - name: Create or update pull request
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        BRANCH_NAME="update-from-private-lang"
        COMMIT_HASH=${{ steps.get-commit.outputs.commit_hash }}
        git config pull.ff only
        echo "1"
        git remote update
        echo "2"
        git fetch -p 
        echo "3"
        git checkout $BRANCH_NAME
        echo "4"
        git fetch origin # Fetch the latest changes
        echo "5"
        # Check if the branch is up-to-date
        LOCAL=$(git rev-parse @)
        REMOTE=$(git rev-parse @{u})
        BASE=$(git merge-base @ @{u})
        echo "6"
        if [ $LOCAL = $REMOTE ]; then
          echo "Branch is up-to-date"
        elif [ $LOCAL = $BASE ]; then
          echo "Branch needs to pull"
          git pull origin $BRANCH_NAME # Pull latest update branch changes
        elif [ $REMOTE = $BASE ]; then
          echo "Branch needs to push"
        else
          echo "Branch has diverged"
          exit 1
        fi
        echo "7"
        cp  private-repo/upstream/en_us.json upstream/langs/en_us.json
        rm -rv private-repo
        git add upstream/langs/en_us.json
        echo "8"
        git commit -m "Copied en_us.json from private repo, latest edit commit: $COMMIT_HASH"
        echo "9"
        git push origin $BRANCH_NAME
        # PR_URL=${{ steps.pr-check.outputs.pr_url }}
        # if [ "$PR_URL" = "none" ]; then
          # gh pr create --title "Update en_us.json" --body "Copied en_us.json from private repo, latest edit commit: $COMMIT_HASH" --head $BRANCH_NAME --base main
        # else
          # gh pr edit "$PR_URL" -body "Copied en_us.json from private repo, latest edit commit: $COMMIT_HASH"
        # fi
